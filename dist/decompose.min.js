!function(e){"use strict";e([],function(){function e(e,n,t,r){var u=null;r._deep_ocm_&&(r=r());try{u=e.apply(n,t)}catch(o){u=o}finally{if(!u)return u;if("function"==typeof u.then)return u.then(function(e){return e},function(e){var t=r.call(n,e);return"undefined"==typeof t?e:t});if(u instanceof Error){var i=r.call(n,u);return"undefined"==typeof i?u:i}return u}}var n=function(e,t){var r={queue:[],compiled:!1};e&&(e.__composition__?r.queue=e._queue().slice():e.forEach?r.queue=e.slice():r.queue=[{fn:e,type:t||"fn"}]);var o=function(){return r.forged||(r.forged=u(r)),r.forged.apply(this,arguments)};return o._deep_compiler_=!0,o.__composition__=!0,o._clone=function(){return n(r.queue)},o._forge=function(){return r.forged?r.forged:u(r)},o._queue=function(e,n){return e?(r.forged=null,r.queue.push({fn:e,type:n||"after"}),this):r.queue},o._up=function(e){return e?(r.forged=null,e.__composition__?(r.queue=r.queue.concat(e._queue()),this):(r.queue=[{fn:e,type:"fn"}],this)):null===e?null:this},o._bottom=function(e){return"fn"==r.queue[0].type?this:e?(r.forged=null,e.__composition__?r.queue=e._queue().concat(r.queue):"function"==typeof e&&r.queue.unshift({fn:e,type:"fn"}),this):this},o.after=function(e){return this._queue(e,"after")},o.before=function(e){return this._queue(e,"before")},o.around=function(e){return this._queue(e,"around")},o.fail=function(e){return this._queue(e,"fail")},o.done=function(e){return this._queue(e,"after")},o.always=function(e){return this._queue(e,"after")._queue(e,"fail")},o};n.Arguments=function(e){return e.forEach||(e=[e]),e._compo_arguments_=!0,e},n.Composer=function(e){var t=function(r,u){var o=n(r,u);for(var i in e)o[i]=e[i];return o._clone=function(){return t(this._queue())},o};return t.add=function(n,t){return e[n]=t,this},t};var t=function(e,n,t,r){if(n._deep_ocm_&&(n=n()),!n)return e;"undefined"!=typeof e&&(r=e&&e._compo_arguments_?e:[e]);var u=n.apply(t,r);return u&&"function"==typeof u.then?u.then(function(n){return"undefined"==typeof n?e:n}):"undefined"==typeof u?e:u},r=function(e,n){return function(){var r,u=this,o=e,i=n,f=arguments;return o._deep_ocm_&&(o=o()),o&&(r=o.apply(this,f)),r instanceof Error?r:r&&"function"==typeof r.then?r.then(function(e){return t(e,i,u,f)}):t(r,i,u,f)}},u=function(n){var t=n.queue;if(!t.length)return function(){};if("around"===t[0].type)throw new Error("composition starting with 'around' : could not be compiled. aborting.");{var u=null;t.length}return t.forEach(function(t){var o=null;switch(t.type){case"fn":u=t.fn;break;case"after":u=u?r(u,t.fn,n):t.fn;break;case"before":u=u?r(t.fn,u,n):t.fn;break;case"around":o=u,u=function(){var e=t.fn(o);if(!e)throw new Error(".around() composition is used without returning a function. aborting.");return e.apply(this,arguments)};break;case"fail":o=u,u=function(){return o?e(o,this,arguments,t.fn):void 0};break;default:throw new Error("composition unrecognised : "+t.type)}}),n.forged=u,u};return n.up=function(){var e=Array.prototype.slice.call(arguments),n=e[e.length-1];if(!n.__composition__)return n;for(var t=e.shift();!t;)t=e.shift();if(t.__composition__){for(var r=0,u=e.length;u>r;++r)t._up(e[r]);return t}for(var o=e.pop()._clone(),i=e.length-1;i>=0;--i)o._bottom(e[i]);return o._bottom(t),o},n.bottom=function(){var e=Array.prototype.slice.call(arguments),n=e.pop();if(n.__composition__)for(var t=e.length-1;t>=0;--t)n._bottom(e[t]);return n},n.compile=function(){var e=Array.prototype.slice.call(arguments),n=e.pop();if(n.__composition__){n=n._clone();for(var t=e.length-1;t>=0;--t)n._bottom(e[t])}return n},n})}("undefined"!=typeof define?define:function(e,n){"undefined"!=typeof module?module.exports=n():decompose=n()});
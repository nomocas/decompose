!function(n){"use strict";n([],function(){function n(n,e,t,r){var o=null;try{o=n.apply(e,t)}catch(u){o=u}finally{if(!o)return o;if("function"==typeof o.then)return o.then(function(n){return n},function(n){var t=r.call(e,n);return"undefined"==typeof t?n:t});if(o instanceof Error){var i=r.call(e,o);return"undefined"==typeof i?o:i}return o}}var e=function(n,t){var r={queue:[],compiled:!1};n&&(n.__composition__?r.queue=n._queue().slice():n.forEach?r.queue=n.slice():r.queue=[{fn:n,type:t||"fn"}]);var u=function(){return r.compiled||(r.compiled=o(r)),r.compiled.apply(this,arguments)};return u._deep_compiler_=!0,u.__composition__=!0,u._clone=function(){return e(r.queue)},u._compile=function(){return r.compiled?r.compiled:o(r)},u._queue=function(n,e){return n?(r.compiled=null,r.queue.push({fn:n,type:e||"after"}),this):r.queue},u._up=function(n){return r.compiled=null,n.__composition__?(r.queue=r.queue.concat(n._queue()),this):(r.queue=[{fn:n,type:"fn"}],this)},u._bottom=function(n){return"fn"==r.queue[0].type?this:(r.compiled=null,n.__composition__?r.queue=n._queue().concat(r.queue):"function"==typeof n&&r.queue.unshift({fn:n,type:"fn"}),this)},u.after=function(n){return this._queue(n,"after")},u.before=function(n){return this._queue(n,"before")},u.around=function(n){return this._queue(n,"around")},u.fail=function(n){return this._queue(n,"fail")},u.done=function(n){return this._queue(n,"after")},u.always=function(n){return this.after(n).fail(n)},u};e.Arguments=function(n){return n.forEach||(n=[n]),n._compo_arguments_=!0,n},e.Composer=function(n){var t=function(r,o){var u=e(r,o);for(var i in n)u[i]=n[i];return u._clone=function(){return t(this._queue())},u};return t.add=function(e,t){return n[e]=t,this},t};var t=function(n,e,t,r){if(e._deep_ocm_&&(e=e()),!e)return n;"undefined"!=typeof n&&(r=n&&n._compo_arguments_?n:[n]);var o=e.apply(t,r);return o&&"function"==typeof o.then?o.then(function(e){return"undefined"==typeof e?n:e}):"undefined"==typeof o?n:o},r=function(n,e){return function(){var r,o=this,u=n,i=e,f=arguments;return u._deep_ocm_&&(u=u()),u&&(r=u.apply(this,f)),r instanceof Error?r:r&&"function"==typeof r.then?r.then(function(n){return t(n,i,o,f)}):t(r,i,o,f)}},o=function(e){var t=e.queue;if(!t.length)return function(){};if("around"===t[0].type)throw new Error("composition starting with 'around' : could not be compiled. aborting.");{var o=null;t.length}return t.forEach(function(t){var u=null;switch(t.type){case"fn":o=t.fn;break;case"after":o=o?r(o,t.fn,e):t.fn;break;case"before":o=o?r(t.fn,o,e):t.fn;break;case"around":u=o,o=function(){var n=t.fn(u);if(!n)throw new Error(".around() composition is used without returning a function. aborting.");return n.apply(this,arguments)};break;case"fail":u=o,o=function(){return u?n(u,this,arguments,t.fn):void 0};break;default:throw new Error("composition unrecognised : "+t.type)}}),e.compiled=o,o};return e.up=function(){var n=Array.prototype.slice.call(arguments);if(!n[n.length-1].__composition__)return n[n.length-1];var e=n.shift();if(e.__composition__){for(var t=0,r=n.length;r>t;++t)e._up(n[t]);return e}for(var o=n.pop()._clone(),r=n.length-1;r>=0;--r)o._bottom(n[r]);return o._bottom(e),o},e.bottom=function(){var n=Array.prototype.slice.call(arguments),e=n.pop();if(e.__composition__)for(var t=n.length-1;t>=0;--t)e._bottom(n[t]);return e},e.compile=function(){var n=Array.prototype.slice.call(arguments),e=n.pop();if(e.__composition__){e=e._clone();for(var t=n.length-1;t>=0;--t)e._bottom(n[t])}return e},e})}("undefined"!=typeof define?define:function(n,e){"undefined"!=typeof module?module.exports=e():decompose=e()});
!function(n){"use strict";n([],function(){function n(n,e,t,r){var u=null;try{u=n.apply(e,t)}catch(o){u=o}finally{if(!u)return u;if("function"==typeof u.then)return u.then(function(n){return n},function(n){var t=r.call(e,n);return"undefined"==typeof t?n:t});if(u instanceof Error){var i=r.call(e,u);return"undefined"==typeof i?u:i}return u}}var e=function(n,t){var r={queue:[],compiled:!1};n&&(n.__composition__?r.queue=n._queue().slice():n.forEach?r.queue=n.slice():r.queue=[{fn:n,type:t||"fn"}]);var o=function(){return r.compiled||(r.compiled=u(r)),r.compiled.apply(this,arguments)};return o._deep_compiler_=!0,o.__composition__=!0,o._clone=function(){return e(r.queue)},o._compile=function(){return r.compiled?r.compiled:u(r)},o._queue=function(n,e){return n?(r.compiled=null,r.queue.push({fn:n,type:e||"after"}),this):r.queue},o._up=function(n){return n?(r.compiled=null,n.__composition__?(r.queue=r.queue.concat(n._queue()),this):(r.queue=[{fn:n,type:"fn"}],this)):null===n?null:this},o._bottom=function(n){return"fn"==r.queue[0].type?this:n?(r.compiled=null,n.__composition__?r.queue=n._queue().concat(r.queue):"function"==typeof n&&r.queue.unshift({fn:n,type:"fn"}),this):this},o.after=function(n){return this._queue(n,"after")},o.before=function(n){return this._queue(n,"before")},o.around=function(n){return this._queue(n,"around")},o.fail=function(n){return this._queue(n,"fail")},o.done=function(n){return this._queue(n,"after")},o.always=function(n){return this.after(n).fail(n)},o};e.Arguments=function(n){return n.forEach||(n=[n]),n._compo_arguments_=!0,n},e.Composer=function(n){var t=function(r,u){var o=e(r,u);for(var i in n)o[i]=n[i];return o._clone=function(){return t(this._queue())},o};return t.add=function(e,t){return n[e]=t,this},t};var t=function(n,e,t,r){if(e._deep_ocm_&&(e=e()),!e)return n;"undefined"!=typeof n&&(r=n&&n._compo_arguments_?n:[n]);var u=e.apply(t,r);return u&&"function"==typeof u.then?u.then(function(e){return"undefined"==typeof e?n:e}):"undefined"==typeof u?n:u},r=function(n,e){return function(){var r,u=this,o=n,i=e,f=arguments;return o._deep_ocm_&&(o=o()),o&&(r=o.apply(this,f)),r instanceof Error?r:r&&"function"==typeof r.then?r.then(function(n){return t(n,i,u,f)}):t(r,i,u,f)}},u=function(e){var t=e.queue;if(!t.length)return function(){};if("around"===t[0].type)throw new Error("composition starting with 'around' : could not be compiled. aborting.");{var u=null;t.length}return t.forEach(function(t){var o=null;switch(t.type){case"fn":u=t.fn;break;case"after":u=u?r(u,t.fn,e):t.fn;break;case"before":u=u?r(t.fn,u,e):t.fn;break;case"around":o=u,u=function(){var n=t.fn(o);if(!n)throw new Error(".around() composition is used without returning a function. aborting.");return n.apply(this,arguments)};break;case"fail":o=u,u=function(){return o?n(o,this,arguments,t.fn):void 0};break;default:throw new Error("composition unrecognised : "+t.type)}}),e.compiled=u,u};return e.up=function(){var n=Array.prototype.slice.call(arguments),e=n[n.length-1];if(!e.__composition__)return e;for(var t=n.shift();!t;)t=n.shift();if(t.__composition__){for(var r=0,u=n.length;u>r;++r)t._up(n[r]);return t}for(var o=n.pop()._clone(),u=n.length-1;u>=0;--u)o._bottom(n[u]);return o._bottom(t),o},e.bottom=function(){var n=Array.prototype.slice.call(arguments),e=n.pop();if(e.__composition__)for(var t=n.length-1;t>=0;--t)e._bottom(n[t]);return e},e.compile=function(){var n=Array.prototype.slice.call(arguments),e=n.pop();if(e.__composition__){e=e._clone();for(var t=n.length-1;t>=0;--t)e._bottom(n[t])}return e},e})}("undefined"!=typeof define?define:function(n,e){"undefined"!=typeof module?module.exports=e():decompose=e()});